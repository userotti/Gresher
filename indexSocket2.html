<!DOCTYPE html>
<html>
<head>
    <title>GRSH - Socket 2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">

    <link rel="stylesheet" href="css/styles.css" type="text/css" />

    <!-- Libraries -->
    <script src="js/libs/stats.min.js"></script>
    <script src="bower_components/pixi/bin/pixi.dev.js"></script>
    <script src="js/libs/jquery-1.11.0.min.js"></script>
    <script src="js/libs/underscore/underscore-min.js"></script>

    <script src="js/libs/gamecore.min.js"></script>

    <!-- Gresher Javascript -->
    <script src="js/globals.js"></script>
    <script src="js/destenationspresets.js"> </script>
    <script src="js/ai.js"></script>
    <script src="js/smaatclasses.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/colorfuncs.js"></script>
    <script src="js/towerpresets.js"></script>
    <script src="js/shrappresets.js"></script>
    <script src="js/shrap.js"></script>
    <script src="js/tower.js"></script>
    <script src="js/level.js"></script>
    <script src="js/gamescene.js"></script>
    <script src="js/gresher.js"></script>
</head>
   <body>
      <h1>Votes Frontend</h1>
      <p>Open JavaScript console to watch output.</p>
      <script>AUTOBAHN_DEBUG = true;</script>
      <script type="text/javascript" src="autobahn.js"></script>

      <button onclick="vote('banana')">Banana</button>
      <button onclick="vote('lemon')">Lemon</button>
      <button onclick="vote('grapefruit')">Grapefruit</button>

      <script>
         var wsuri;
         var users = new gamecore.Hashtable();

         if (window.location.protocol === "file:") {
             wsuri = "ws://localhost:8080/ws";
         } else {
             wsuri = "ws://" + window.location.hostname + ":8080/ws";
         }

         var connection = new autobahn.Connection({
            url: wsuri,
            realm: 'realm1'}
         );

         connection.onopen = function (session) {

            //users.put(session.id,Tower.create(BASICJELLY, ONSCREENRANDOM(), JELLIESTEAM, STILLAI, NODEST, gresher.currentscene.effects_layer, gresher.currentscene.colidables_layer));

            session.subscribe('com.votegame.onmove', function (args) {
               console.log("new moves for : " + args[0] + " -> " + args[1] + " : " + args[2]);

                // Other Players
                 if( args[0] != connection.session.id ){

                       if(users.get(args[0]) === null){
                            console.log('Click found but no users??');
                            users.put(args[0], Tower.create(BASICJELLY, ONSCREENRANDOM(), JELLIESTEAM, STILLAI, NODEST, gresher.currentscene.effects_layer, gresher.currentscene.colidables_layer));
                            users.get(args[0]).startBoost(args[1],args[2]);
                        } else {
                            console.log('Click: Other: ' + args[0]);
                            users.get(args[0]).startBoost(args[1],args[2]);
                        }

                 } else {
                     gresher.currentscene.player.startBoost(args[1],args[2]);
                 }
            });

            session.subscribe('com.votegame.onvote', function (args) {
               console.log("new votes for " + args[0] + " : " + args[1]);


            });

            session.call('com.votegame.get_votes').then(
               function (votes) {
                  console.log("Current votes:", votes);
               },
               session.log
            );

            // CALL - Register User, Return Entiry
            var email = 'doos@dooskop.com';
             session.call('com.votegame.signup', [email]).then(
                     function (entity) {
                         console.log("Registered (" + email + ") with Entity " + entity);
                     },
                     connection.session.log
             );

         };



         connection.open();

         window.onbeforeunload = function() {

             connection.close()

         };



      </script>
      <script>

          //KEYBOARD
          var Key = {
              _pressed: {},

              LEFT: 37,
              UP: 38,
              RIGHT: 39,
              DOWN: 40,

              isDown: function(keyCode) {
                  return this._pressed[keyCode];
              },

              onKeydown: function(event) {
                  this._pressed[event.keyCode] = true;
              },

              onKeyup: function(event) {
                  delete this._pressed[event.keyCode];
              }
          };

          window.addEventListener('keyup', function(event) { Key.onKeyup(event); }, false);
          window.addEventListener('keydown', function(event) { Key.onKeydown(event); }, false);
          window.addEventListener('keypress', function(event) { console.log("Key PRessed"); keypressed() }, false);
          //make the fps stats

          stats = new Stats();
          document.body.appendChild( stats.domElement );
          stats.domElement.style.position = "fixed";
          stats.domElement.style.zIndex = "999";
          stats.domElement.style.bottom = "0px";
          stats.domElement.style.right = "0px";


          //make the game instance

          gresher = new Gresher();


          keypressed = function(){
              console.log("Toggle Pause");
              gresher.paused = !(gresher.paused);


          }


          gresher.stage.click = function(mouseData){

              gresher.handleClickTap(mouseData.originalEvent);

          }

          gresher.stage.tap = function(touchData){


              gresher.handleClickTap(touchData.global);

          }

          gresher.stage.tap = function(touchData){


              gresher.handleClickTap(touchData.global);

          }


          // THIS FUNCTION CALL KICKS OFF THE WHOLE RENDER LOOP PARTY
          requestAnimFrame(update);


          //the main loop function
          function update() {

              if (Key.isDown(Key.UP)) {

              }

              stats.begin();

              gresher.gameupdate();

              requestAnimFrame( update );


              stats.end();
          }

          //the main resize function
          window.onresize = function resize() {

              gresher.resize();
          }

          function vote(item) {
                if (connection.session) {
                   connection.session.call('com.votegame.vote', [item]).then(
                      function (count) {
                         console.log("Ok, voted for " + item + " : " + count);
                      },
                      connection.session.log
                   );
                } else {
                   console.log("can't vote: no connection");
                }
             }

             function svrmove(x,y) {
                 if (connection.session) {
                     connection.session.call('com.votegame.move', [connection.session.id,x,y]).then(
                             function (id) {
                                 console.log("Ok, moved for: " + id +" " + x + " - " + y);

                                 //users.get(id).startBoost(x, y);
                             },
                             connection.session.log
                     );
                 } else {
                     console.log("can't vote: no connection");
                 }
             }

      </script>

     

   </body>
</html>
